<!doctype html>
<html>
<head>
	<!--Copyright (C) 2015 NS Solutions Corporation, All Rights Reserved.  -->
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<meta http-equiv="Pragma" content="no-cache">
	<meta http-equiv="Cache-Control" content="no-cache">
	<meta http-equiv="Expires" content="-1">

	<title>Test results - Pitalium Explorer</title>
	<link rel="shortcut icon" href="res/img/favicon.ico">
	
	
	<link rel="stylesheet" href="/hifive-res/ext/bootstrap/3.3.6/css/bootstrap.css">
	
	<link rel="stylesheet" href="/hifive-res/fw/current/h5.css" data-h5-module="hifive">
	<link rel="stylesheet" href="src/common/common.css">
	<link rel="stylesheet" href="src/list/list.css">
	<link rel="stylesheet" href="lib/jquery-ui/jquery-ui.css">
	<script src="/hifive-res/ext/jquery/jquery-2.js"></script>
	<script src="/hifive-res/ext/bootstrap/3.3.6/js/bootstrap.min.js"></script>
	<script src="lib/jquery-ui/jquery-ui.js"></script>
	<script src="lib/jquery-kinetic/jquery.kinetic.js"></script>
	<script src="/hifive-res/fw/current/ejs-h5mod.js" data-h5-module="hifive:ejs"></script>
	<script src="/hifive-res/fw/current/h5.js" data-h5-module="hifive"></script>

	<script src="src/common/constant.js"></script>
	<script src="src/common/util.js"></script>
	
	
	
	
	</head>
	<body>
	
	
		
		<div class="background-pattern">
			
			<h2>Pitalium explorer</h2>
			<p>The best explorer to analyze the results of Pitalium.</p>
			
		</div>
		<!-- Navigation -->
		<nav class="navbar navbar-fixed-top" style="display:none;">
			<div class="container-fluid">
				<div class="navbar-header">
					<a class="navbar-brand" href="list.html">Pitalium explorer</a>
					
					<form id="searchTest" class="form-inline">
					
					<div class="form-group">
						<label for="searchTestMethod">Test Method</label>
						<input type="text" id="searchTestMethod" name="searchTestMethod" class="form-control" placeholder="Test method to search">
					</div>
					<div class="form-group">
						<label for="searchTestScreen">Test Screen</label>
						<input type="text" id="searchTestScreen" name="searchTestScreen" class="form-control" placeholder="Test screen to search">
					</div>
					<button type="submit" class="btn btn-default">Search</button>
				</form>
				</div>
			</div>
		</nav>
		<!-- Navigation -->

		<div class="container col-md-8 col-md-offset-2 margin-top" id="container">
			<h4 style="color: #039BE5;">Test results</h4>
		
	

			<div class="col-md-12" id="result_list" >
				
			</div>

		</div>
		
		<div class="modal fade" id="diffDetail" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
		  <div class="modal-dialog modal-lg" role="document">
		    <div class="modal-content">
		      <div class="modal-header">
		        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
		        <h4 class="modal-title" id="myModalLabel">Difference detail</h4>
		      </div>
		      
		      <div class="modal-body">
		      	<div id="result_box" >
		      	 	<div id="test_result" style="position:relative;">
		      	 	
		        
		        	</div>
		      	</div>
		       
		      </div>
		      
		    </div>
		  </div>
		</div>
		
		
		
		<div class="footer col-sm-12">
			<p>Copyright (C) 2012-2016 NS Solutions Corporation, All Rights Reserved.</p>
		
		</div>
		
		<div id="memobox">
			
		</div>
		
		
		<script>
		
		$('#result_box').kinetic();
		
		$(document).on("mouseenter", ".diffDiv", function(){
			var rectype = $(this).data("rectype");
			var method1 = $(this).data("method1");
			var method2 = $(this).data("method2");
			
			var method3 = $(this).data("method3");
			var xshift = $(this).data("xshift");
			var yshift = $(this).data("yshift");
			
			
			var data1 = {
					
					type: rectype,
					method1: method1,
					method2: method2,
					method3: method3,
					xshift: xshift,
					yshift: yshift
					
			};
			
			h5.core.view.update("#memobox", "memo_content", data1);
			

			$("#memobox").show();
			$(".diffDiv").css("opacity", "0.3");
			$(this).css("opacity", "0.6");
		});
		
		
		
		$(document).on("mouseleave", ".diffDiv", function(){
			$("#memobox").hide();
			$(this).css("opacity", "0.3");
		});
		
		$(document).on('mousemove', function(e){
		    $('#memobox').css({
		       left:  e.pageX + 10,
		       top:   e.pageY - 20
		    });
		});
		$(document).on("mouseenter", ".platform", function(){
			$(this).find("img").hide();
			$(this).find("span").show();
		});
		$(document).on("mouseleave", ".platform", function(){
			$(this).find("img").show();
			$(this).find("span").hide();
		});
		
		
		$(document).ready(function(){
			
			load_list();
			
		});
		
		
		function load_list() {
			var result_list_url = './_results/list.json';
			
			$.ajax({
				url: result_list_url,
				success: function(data){
					
					var content = data["content"];
					var options = {
						    weekday: "long", year: "numeric", month: "short",
						    day: "numeric", hour: "2-digit", minute: "2-digit"
						};
					
					
					for (var i = 0; i < content.length; i++){
					
						var result_name = content[i]["name"];
						var tString = String(content[i]["timestamp"]);
						
						var tStamp = new Date(tString.substr(0, 4), (parseInt(tString.substr(4,2)) - 1), tString.substr(6,2), tString.substr(8,2), tString.substr(10,2));
						var mytimes = tStamp.toLocaleTimeString("en", options)
						var dir_timestamp = String(content[i]["dirTimestamp"]);
						var path = dir_timestamp+"/"+result_name;
						
						var NofScreenshots = content[i]["numberOfScreenshots"];
						var NofResult = content[i]["numberOfResults"];
						
						var data = {id: content[i]["id"], name: result_name, time: mytimes, screenshot: NofScreenshots, result: NofResult, path: path};
						
						h5.core.view.append("#result_list", "mylist", data);
						
						
						
					}
					
				}
				
			});
		}
		
		
		$(document).on("click", ".appendTable", function(){
			
			var id = $(this).data("id");
			var path = $(this).data("path");
			
			$("#table_list_" + id).slideToggle();
			
			appendScreenshots(path,id);
			
		});
		
		
		function appendScreenshots(path, id){
			
			var table = $("#table_" + String(id));
			var t_id = "#table_" + String(id);
			var table_list = $("#table_list_" + String(id));

			
			
			if (table_list.css("display") != "none"){
				
				var screenshot_list_url = "./_screenshots/list.json";
				$.ajax({
					
					url: screenshot_list_url,
					type: 'GET',
					data: {path: path, refresh: "true"},
					success: function(data){
						
						var feedback = data["screenshotFileList"];
	
						table.find(".tr").remove();
						var resultList = data["resultList"];

						$("#result_ul_" + id).html("");
						
						for (var i = 0; i < resultList.length; i++){
							
							var result = resultList[i];
							var tStamp = new Date(parseInt(result["executionTime"]));
							
							var options = {
								    weekday: "long", year: "numeric", month: "short",
								    day: "numeric", hour: "2-digit", minute: "2-digit"
								};
							
							
							$("#result_h_" + String(id)).show();
							var my_data = {
								id: result["id"],
								resultList: result["resultList"],
								expected: result["expectedFilename"],
								timestamp: tStamp.toLocaleTimeString("en", options),
								directory: path 
							}
							
							h5.core.view.append($('#result_ul_' + String(id)), "result_info_table", my_data);
							
							
						}
						
						
						for (var i = 0; i < feedback.length; i++){
							var tc = feedback[i];
							
							var my_data = {
									id: id,
									name: tc["name"], 
									timestamp: tc["timestamp"],
									platform: tc["platform"],
									browser: tc["browser"],
									version: tc["version"],
									width: tc["width"],
									height: tc["height"],
									directory: path,
									results: resultList
							};
							
							
							
							h5.core.view.append(table, "screenshot_list", my_data);
							
							
						}
						
						
					}
					
				});
			}
			
		}
		
		$(document).on("click", ".expected", function(){
			var directory = $(this).data("directory");
			var target = $(this).val();
			
			
			$(".btn-run").hide();
			$(".expected").show();
			
			find_input(2, directory, target).show();
			
			
			$(".compare").show();
			var this_checkbox = find_input(1, directory, target);
			var all_checkbox = find_input(1, directory);
			
			all_checkbox.show();
			all_checkbox.prop("checked", true);
			this_checkbox.hide();
			this_checkbox.removeAttr("checked");
			
			
		});
		
		
		$(document).on("click", ".btn-run", function(){
			
			var targets = new Array;
			var run_btn = $(this);
			run_btn.hide();
			
			var loading_img = $(this).parent().find("img");
			loading_img.show();
			
			
			$(".compare:checked").each(function(){
				
				targets.push($(this).data("target"));
				
			});
			
			var directory = $(this).data("directory");
			var expected = $(this).data("target");
			
			
			$.ajax({
				url: "_screenshots/compare.json",
				type: "POST",
				data: {
					path: directory,
					targets: String(targets),
					expected: expected
				},
				
				success: function(data){
					
					console.log(data);
					appendScreenshots(directory, run_btn.data("id"));
					loading_img.hide();
					run_btn.show();
					
				}
				
		});
			
			
		});
		
		function find_input(type, directory, target){
			
			
			if (target == null){
				switch (parseInt(type)) {
				case 0: 
					return $(document).find("input[type=radio][data-directory='" + directory + "']");
				case 1:
					return $(document).find("input[type=checkbox][data-directory='" + directory + "']");
				case 2:
					return $(document).find("a[data-directory='" + directory + "']");
				
				}
			}else{
				
				switch (parseInt(type)) {
				case 0: return $(document).find("input[type=radio][data-directory='" + directory + "'][data-target='" + target + "']");
				case 1: return $(document).find("input[type=checkbox][data-directory='" + directory + "'][data-target='" + target + "']");
				case 2:
					return $(document).find("a[data-directory='" + directory + "'][data-target='" + target + "']");
				}
			
				
			}
					
			
		}
		
		$(document).on("click", ".btn-detail", function(){
			
			var directory = $(this).data("directory");
			var target = $(this).data("target");
			var expected = $(this).data("expected");
			var resultListId = $(this).data("result_list_id");
			var targetResultId = $(this).data("target_result_id");
			
			
			$("#diffDetail").modal("show");
			$("#test_result").height("300");
			$("#test_result").width("100%");
			$("#test_result").css("background", "#fff url('res/img/big_loading.gif') center no-repeat");

			$(".diffDiv").remove();
			
			$.ajax({
				url: "_screenshots/images.json",
				type: "GET",
				data: {
					path: directory,
					target: target,
					expected: expected
				},
				success: function(data){
					
					
					var img = new Image();
					img.onload = function() {
						$("#test_result").height(this.height);
						$("#test_result").width(this.width);
						$("#test_result").css("background", "url('" + this.src + "')");
					}
					
					img.src = "data:image/png;base64," + data["targetImage"];
					
					drawRec(directory, resultListId, targetResultId);
					
				}
			
				
			});
			
			
			
			
		});
		
		
		function drawRec(directory, resultId, targetResultId){
			
			
			$.ajax({
				url: "_screenshots/result.json",
				type: "GET",
				data: {
					path: directory,
					resultListId: resultId,
					targetResultId: targetResultId
				},
				success: function(data){

					console.log(data);
					for (var i = 0; i < data.length; i++){
						
						var rec = data[i];
						var my_data;
						
						console.log(rec);
						
						if (rec["type"] == "SHIFT"){
							
							my_data = {
									
									x: rec["x"],
									y: rec["y"],
									width: rec["width"],
									height: rec["height"],
									type: rec["type"],
									xshift: rec["xshift"],
									yshift: rec["yshift"],
									method1: 0,
									method2: 0,
									method3: 0
									
							};
						}else{
							
							
							
							if (rec["method3"] == null){
								method3 = "null";
							}else{
								
								method3 = rec["method3"]["similarity"];
							}
							my_data = {
									x: rec["x"],
									y: rec["y"],
									width: rec["width"],
									height: rec["height"],
									type: rec["type"],
									method1: rec["method1"]["similarity"],
									method2: rec["method2"]["similarity"],
									method3: method3
									
							}
						}
						
						h5.core.view.append("#test_result", "diffDiv", my_data);
						
						
					}
					
					
				}
					
			
			});
		}
		
		
		$(document).on("click", ".result_info", function(){
			
			$(this).parent().find(".info_table_div").slideToggle();
			
		});
		
		
		</script>
		
		
		
		<script type="text/ejs" id="diffDiv">
			<div class="diffDiv" style="left: [%=x%]px; top: [%=y%]px; width: [%=width%]px; height: [%=height%]px;"
					data-rectype="[%=type%]"
					[%if (type != "SHIFT"){%]
						data-method1="[%=method1%]"
						data-method2="[%=method2%]"
						data-method3="[%=method3%]"
					[%}else{%]
						data-xshift="[%=xshift%]"
						data-yshift="[%=yshift%]"
					[%}%]
					>

		      	 			
		    </div>

		</script>
		
		
		
		<script type="text/ejs" id="result_info_table">

			<div class="col-sm-12 result_info_container" style="margin:0; padding:0;">
			<div class="result_info col-sm-12 col-md-12"style="margin:0; padding:0; border-bottom: 1px solid #E0E0E0;">
				<div class="col-sm-1 col-md-1"style="margin:0; ">

					<div style="min-height:66px; padding-top: 15px; padding-bottom:15px;">
						<i class="glyphicon glyphicon-ok-sign" style="font-size:25px; margin:0; color:#8BC34A;"></i></div>
					</div>
				<div class="col-sm-10 col-md-10" style="margin:0">
					<div class="col-sm-12 col-md-12" style="margin:0">
						<h4>[%=expected%]</h4>
					</div>
					<div class="col-sm-12 col-md-12" style="margin:0; color:#90A4AE">
						<p>[%=timestamp%]</p>
					</div>
				</div>
				
			</div>
			<div class="col-sm-12 col-md-12 info_table_div" style="display:none;">
			<table class="info_table table" >
				<tr>
					<th>
						Expected
					</th>
					<th>
						Compare
					</th>
					<th>
						Similarity
					</th>
					<th>
						Diff points
					</th>
					<th>
						Detail
					</th>
				</tr>


				[%for (var i = 0; i < resultList.length; i++){ %]
					<tr>
						<td>[%=expected%]</td>
						<td>[%=resultList[i]["targetFilename"]%]</td>
						<td>[%=Math.round(resultList[i]["entireSimilarity"]*100)/100%]</td>
						<td>[%=resultList[i]["numberOfDiffRec"]%]</td>
						
						<td><a  class="btn btn-danger btn-detail" data-result_list_id="[%=id%]" data-target_result_id="[%=resultList[i]["id"]%]" data-expected="[%=expected%]" data-target="[%=resultList[i]["targetFilename"]%]" data-directory="[%=directory%]" >Detail</a></td>
					<tr>
				[%}%]
				
				
			</table>
			</div>
			</div>
			
		</script>
		
		<script type="text/ejs" id="mylist">
			<div class="result_content">
				
				<a class="appendTable" data-path="[%=path%]" data-name="[%=name%]" data-id=[%=id%]>[%=name%] ([%=time%]) ([%=result%]/[%=screenshot%])</a>

				<div class="table_list" id="table_list_[%=id%]" style="display:none;">
					<h4 id="result_h_[%=id%]" style="display:none; color:#00897B;">Result List</h4>
					<hr style="border-bottom: 1px solid #00897B;">

					<div id="result_ul_[%=id%]" class="result_ul">
						

					</div>

					<table class="table" id="table_[%=id%]" >
							<tbody><tr class="th_tr">
								<th>
									Name
								</th>
								<th>
									Platform
								</th>
								<th>
									Browser
								</th>
								<th>
									Version
								</th>
								<th>
									Expected
								</th>

								<th>
									Compare
								</th>

								<th>
									Run
								</th>
								
							</tr>
					</table>
				
				</div>

			</div>
		</script>
		
		<script type="text/ejs" id="screenshot_list">
			<tr class="tr">
								<td>
									[%=name%]
								</td>
								<td class="platform">
									<img src="res/img/windows.svg" style="height: 15px; display: inline;">
									<span style="display: none;">[%=platform%]</span>
								</td>
								<td>
									[%=browser%]
								</td>
								<td>
									11
								</td>
								<td class="text-center">
									<input class="expected" name="expected" type="radio" value="[%=name%]" data-directory="[%=directory%]">
									
								</td>
								<td>
									
									<input type="checkbox" class="compare compare_checkbox" data-target="[%=name%]" data-directory="[%=directory%]" style="display:none;">
								</td>
								<td>
									<a class="btn-info btn btn-run" style="display:none;" data-id="[%=id%]" data-target="[%=name%]" data-directory="[%=directory%]">
										<span class="glyphicon glyphicon-play-circle" aria-hidden="true"></span> Run
									</a>
									<img src="res/img/loading.gif" style="width:34px; display:none; margin-left: 20px; margin-right:20px;"/>
								</td>
			</tr>
		</script>
		
		<script type="text/ejs" id="memo_content">
			<h5>

			[%if (type == "SHIFT"){%]
				<i class="glyphicon glyphicon-move"></i> Shifted
			[%}else{%]
				<i class="glyphicon glyphicon-stats"></i> Similar
				
			[%}%]

			</h5>
			
			<hr style="border-color:#8D6E63;">

			[%if (type == "SHIFT"){%]
				<p>x-shift: [%=xshift%]
				</p>
				<p>y-shift: [%=yshift%]
				</p>
			[%}else{%]
				<h5>
			Method 1
			</h5>
			<p>
			Similarity: [%=method1%]
			</p>
			<h5>Method 2</h5>
			<p>
			Similarity: [%=method2%]
			</p>

			<h5>Method 3</h5>
			<p>
			Similarity: [%=method3%]
			</p>

			[%}%]
			
			
		</script>
		
		
	</body>
</html>